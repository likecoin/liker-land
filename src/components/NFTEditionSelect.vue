<template>
  <div :class="rootClasses">
    <table
      v-if="!isSingleItem && !isAllSoldOut"
      class="border-separate border-spacing-y-[8px] mb-[8px] w-full"
    >
      <tbody>
        <NFTEditionSelectItem
          v-for="(item, index) in items"
          :key="index"
          :name="item.name"
          :price-label="item.priceLabel"
          :stock="item.stock"
          :is-selected="item.value === selectedValue"
          @click="handleClickPriceSelectItem(item)"
        />
      </tbody>
    </table>

    <div
      :class="[
        'flex',
        'flex-wrap',
        'justify-end',
        'items-center',
        'gap-[12px] sm:gap-x-[24px]',
        'flex-col sm:flex-row',
      ]"
    >
      <!-- <ButtonV2
        v-if="!isSingleItem && !isAllSoldOut"
        preset="plain"
        class="text-white underline"
        :text="$t('nft_edition_select_compare_button_text')"
        @click="handleClickCompareItemsButton"
      /> -->
      <template v-if="isSingleItem || isAllSoldOut">
        <span
          v-if="!isAllSoldOut"
          class="text-white"
        >{{ priceLabel }}</span>
        <NFTStockLabel
          :stock="stock"
          :is-dark="!isAllSoldOut"
        />
      </template>

      <ButtonV2
        v-if="!isAllSoldOut"
        preset="secondary"
        :text="$t('nft_edition_select_confirm_button_text')"
        @click="handleClickCollectButton"
      >
        <template #prepend>
          <NFTWidgetIconInsertCoin class="w-[16px]" />
        </template>
      </ButtonV2>
      <ButtonV2
        v-else-if="shouldShowNotifyButton"
        preset="outline"
        :text="$t('nft_edition_select_notify_button_text')"
        @click="handleClickNotifyButton"
      >
        <template #prepend>
          <NotifyIcon class="w-[16px]" />
        </template>
      </ButtonV2>
    </div>
  </div>
</template>

<script>
import ButtonV2 from './ButtonV2';
import NotifyIcon from './Icon/Notify';
import NFTEditionSelectItem from './NFTEditionSelectItem';
import NFTStockLabel from './NFTStockLabel';
import NFTWidgetIconInsertCoin from './NFTWidget/Icon/InsertCoin';

export default {
  name: 'NFTEditionSelect',
  components: {
    ButtonV2,
    NotifyIcon,
    NFTEditionSelectItem,
    NFTStockLabel,
    NFTWidgetIconInsertCoin,
  },
  props: {
    items: {
      type: Array,
      validator(items) {
        if (!items.length) return true;
        return items.every(
          item =>
            item.value &&
            item.name &&
            item.priceLabel &&
            !Number.isNaN(item.stock) &&
            item.stock >= 0
        );
      },
      default: () => [],
    },
    value: {
      type: String,
      default: '',
    },
    shouldShowNotifyButton: {
      type: Boolean,
      default: true,
    },
  },
  data() {
    // NOTE: If the selected item is out of stock, select another item.
    const items = [...this.items];
    let selectedItem = items.find(item => item.value === this.value);
    if (!selectedItem || selectedItem.stock <= 0) {
      selectedItem = items.find(
        item =>
          (selectedItem && item.value !== selectedItem.value) || item.stock > 0
      );
    }
    return {
      selectedValue: selectedItem.value || this.value,
    };
  },
  computed: {
    rootClasses() {
      const classes = [
        this.isAllSoldOut ? 'bg-gray-f7' : 'bg-like-green',
        'rounded-[16px]',
      ];
      if (this.isAllSoldOut) {
        classes.push('p-[24px]');
      } else if (this.isSingleItem) {
        classes.push('px-[20px]', 'py-[20px] sm:py-[8px]');
      } else {
        classes.push(
          'p-[12px] sm:p-[24px]',
          'pt-[4px] sm:pt-[16px]',
          'pb-[14px]'
        );
      }
      return classes;
    },
    isSingleItem() {
      return this.items.length === 1;
    },
    selectedItem() {
      return this.items.find(item => item.value === this.selectedValue);
    },
    stock() {
      return this.selectedItem?.stock;
    },
    priceLabel() {
      return this.selectedItem?.priceLabel;
    },
    isAllSoldOut() {
      return this.items.every(
        item => item.stock === 0 || item.priceLabel === undefined
      );
    },
  },
  mounted() {
    if (this.selectedValue !== this.value) {
      this.$emit('update:value', this.selectedValue);
    }
  },
  methods: {
    handleClickPriceSelectItem({ value }) {
      this.selectedValue = value;
      this.$emit('update:value', value);
    },
    handleClickCollectButton() {
      this.$emit('click-collect', this.selectedValue);
    },
    handleClickNotifyButton() {
      this.$emit('click-notify');
    },
    handleClickCompareItemsButton() {
      this.$emit('click-compare');
    },
  },
};
</script>
